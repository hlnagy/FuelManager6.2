{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 fade-in">
    <div>
        <h2 class="mb-1">Gestionare Stoc</h2>
        <p class="text-muted mb-0">Administrare cantități și istoric operațiuni</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-dark shadow-sm rounded-pill px-4" onclick="generateStockSnapshot()">
            <i class="bi bi-camera-fill me-2"></i> Snapshot
        </button>
        <a href="/admin/history/undo{% if active_company_id %}?company_id={{ active_company_id }}{% endif %}"
            class="btn btn-warning shadow-sm" title="Anulează ultima acțiune">
            <i class="bi bi-arrow-counterclockwise me-1"></i> Undo
        </a>
        <a href="/admin/history/redo{% if active_company_id %}?company_id={{ active_company_id }}{% endif %}"
            class="btn btn-info shadow-sm text-white" title="Reface ultima acțiune anulată">
            <i class="bi bi-arrow-clockwise me-1"></i> Redo
        </a>
    </div>
</div>

<!-- Tabs -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-transparent border-bottom-0 pb-0 pt-3">
        <ul class="nav nav-tabs card-header-tabs" id="companyTabs" role="tablist">
            {% for company in companies %}
            {% set is_active = (active_company_id == company.id) or (active_company_id is none and loop.first) %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {{ 'active' if is_active else '' }} px-4 py-2 position-relative fw-bold"
                    id="tab-{{ company.id }}" data-bs-toggle="tab" data-bs-target="#content-{{ company.id }}"
                    type="button" role="tab" aria-selected="{{ 'true' if is_active else 'false' }}"
                    style="--tab-color: {{ company.color_hex }};">
                    <i class="bi bi-building me-2"></i>{{ company.name }}
                </button>
            </li>
            {% endfor %}

            <li class="nav-item" role="presentation">
                <button
                    class="nav-link {{ 'active' if (active_company_id == -1) else '' }} px-4 py-2 position-relative fw-bold {% if unallocated_history %}text-danger{% else %}text-muted{% endif %}"
                    id="tab-unallocated" data-bs-toggle="tab" data-bs-target="#content-unallocated" type="button"
                    role="tab" aria-selected="{{ 'true' if (active_company_id == -1) else 'false' }}"
                    style="{% if unallocated_history %}--tab-color: #dc3545; border-bottom: 2px dashed #dc3545 !important;{% else %}--tab-color: #6c757d;{% endif %}">
                    <i
                        class="bi {% if unallocated_history %}bi-exclamation-triangle{% else %}bi-check-circle{% endif %} me-2"></i>Alimentari
                    nealocate
                    <span class="badge {% if unallocated_history %}bg-danger{% else %}bg-secondary{% endif %} ms-2">{{
                        unallocated_history|length }}</span>
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body bg-body p-4 rounded-bottom">
        <div class="tab-content" id="companyTabsContent">
            {% if not companies %}
            <div class="text-center py-5 fade-in">
                <div class="mb-4">
                    <i class="bi bi-building-add display-1 text-muted opacity-25"></i>
                </div>
                <h3 class="fw-bold text-dark">Nici o firmă configurată</h3>
                <p class="text-muted mb-4">Pentru a gestiona stocuri și a înregistra operațiuni manuale, trebuie să
                    adăugați mai întâi o firmă.</p>
                <a href="/admin/company/new" class="btn btn-primary btn-lg shadow">
                    <i class="bi bi-plus-circle me-2"></i>Adaugă Prima Firmă
                </a>
            </div>
            {% endif %}

            {% for company in companies %}
            {% set is_active = (active_company_id == company.id) or (active_company_id is none and loop.first) %}
            <div class="tab-pane fade {{ 'show active' if is_active else '' }}" id="content-{{ company.id }}"
                role="tabpanel">

                <!-- Stats & Actions Row -->
                <div class="row g-4 mb-5">
                    <!-- Current Stock Card -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm"
                            style="background-color: {{ stocks[company.id]['color_hex'] }}0D;">
                            <div class="card-body text-center d-flex flex-column justify-content-center p-4">
                                <h6 class="text-uppercase fw-bold mb-3"
                                    style="color: {{ stocks[company.id]['color_hex'] }};">Stoc
                                    Actual Motorină</h6>
                                <div class="display-4 fw-bold mb-2"
                                    style="color: {{ stocks[company.id]['color_hex'] }};">
                                    {{ stocks[company.id]['current']|format_thousands(2) }} <span class="fs-4">L</span>
                                </div>
                                <div class="small" style="color: {{ stocks[company.id]['color_hex'] }}A0;">
                                    <i class="bi bi-clock-history me-1"></i>
                                    {% if stocks[company.id]['last_update'] %}
                                    Ultima: {{ stocks[company.id]['last_update'].strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                    Nici o alimentare recentă
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Add Form -->
                    <div class="col-md-5">
                        <div class="card h-100 border shadow-sm">
                            <div class="card-header bg-transparent py-3">
                                <h6 class="mb-0 fw-bold"><i
                                        class="bi bi-plus-circle me-2 text-{{ stocks[company.id]['color'] }}"></i>Operațiuni
                                    Rapide
                                </h6>
                            </div>
                            <div class="card-body p-4">
                                <form action="/admin/stock/add_detailed" method="post">
                                    <input type="hidden" name="company_id" value="{{ company.id }}">

                                    <div class="mb-3">
                                        <div class="row g-2">
                                            <div class="col-7">
                                                <label class="action-label-small ms-1">Operațiune</label>
                                                <div class="custom-dropdown-container" data-onchange="updatePlaceholder"
                                                    data-id="{{ company.id }}">
                                                    <input type="hidden" name="operation_type"
                                                        id="opType-{{ company.id }}" value="IN">
                                                    <button type="button" class="custom-dropdown-btn">
                                                        <span class="btn-label-content"><i
                                                                class="bi bi-plus-circle text-success me-2"></i>
                                                            Intrare</span>
                                                        <i class="bi bi-chevron-down dropdown-chevron"></i>
                                                    </button>
                                                    <div class="custom-dropdown-menu">
                                                        <div class="custom-dropdown-item active" data-value="IN">Intrare
                                                            motorină</div>
                                                        <div class="custom-dropdown-item" data-value="OUT">Ieșire
                                                            motorină</div>
                                                        <div class="custom-dropdown-item" data-value="INITIAL">Stoc
                                                            Inițial</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-5">
                                                <label class="action-label-small ms-1">Cantitate</label>
                                                <input type="number" step="0.01" class="form-control" name="quantity"
                                                    id="qty-{{ company.id }}" required placeholder="Cantitate (Litri)">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-floating mb-3">
                                        <input type="datetime-local" class="form-control" name="date" required
                                            value="{{ now }}">
                                        <label>Data și Ora</label>
                                    </div>

                                    <div class="form-floating mb-3 position-relative">
                                        <input type="text" class="form-control" name="description"
                                            id="desc-{{ company.id }}" placeholder="Descriere" list="vehicleList"
                                            oninput="checkVehicle(this, {{ company.id }})">
                                        <label id="label-{{ company.id }}">Descriere / Document</label>
                                        <div id="newBadge-{{ company.id }}"
                                            class="position-absolute end-0 top-50 translate-middle-y me-3 d-none">
                                            <span class="badge bg-info-subtle text-info border border-info-subtle">
                                                <i class="bi bi-plus-circle me-1"></i> Nou - se va înregistra
                                            </span>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-primary w-100 py-2 fw-medium">
                                        Înregistrează Operațiunea
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Summary List -->
                    <div class="col-md-3">
                        <div class="card h-100 border shadow-sm">
                            <div class="card-header bg-transparent py-3">
                                <h6 class="mb-0 fw-bold">Sumar Total</h6>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                        <span><i class="bi bi-skip-start-circle me-2 text-blue"></i>Inițial</span>
                                        <span class="fw-bold text-blue">{{
                                            stocks[company.id]['initial']|format_thousands(2) }}
                                            L</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                        <span><i class="bi bi-arrow-down-circle me-2 text-success"></i>Intrări</span>
                                        <span class="fw-bold text-success">+{{
                                            stocks[company.id]['in']|format_thousands(2) }}
                                            L</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                        <span><i class="bi bi-arrow-up-circle me-2 text-danger"></i>Consum</span>
                                        <span class="fw-bold text-danger">-{{
                                            stocks[company.id]['consumed']|format_thousands(2) }}
                                            L</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-footer bg-transparent p-3 text-center">
                                <a href="/reports?company_id={{ company.id }}"
                                    class="btn btn-outline-secondary btn-sm w-100">
                                    <i class="bi bi-file-earmark-text me-1"></i> Raport Detaliat
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Table Area -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-transparent py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">Istoric Operațiuni - <span class="text-muted small">{{ company.name
                                }}</span></h5>
                        <button class="btn btn-sm btn-outline-primary rounded-pill" type="button"
                            onclick="toggleSelectionMode('{{ company.id }}')">
                            <i class="bi bi-check2-square me-1"></i> Selecție Multiplă
                        </button>
                    </div>

                    <!-- Search / Filter Area -->
                    <div class="p-3 border-bottom bg-light">
                        <div class="input-group input-group-clean shadow-sm rounded-pill overflow-hidden border">
                            <span class="input-group-text bg-white border-0 ps-3">
                                <i class="bi bi-search text-primary"></i>
                            </span>
                            <input type="text" class="form-control border-0 py-2"
                                placeholder="Caută în istoric (dată, vehicul, tip...)" id="searchInput-{{ company.id }}"
                                oninput="filterHistory(this, '{{ company.id }}')">
                            <button class="btn btn-white border-0 text-muted px-3" type="button"
                                onclick="resetHistoryFilter('{{ company.id }}')">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="card-body p-0">
                        <!-- No Results Placeholder -->
                        <div id="noResults-{{ company.id }}" class="text-center py-5 d-none">
                            <div class="mb-3">
                                <i class="bi bi-search display-1 text-muted opacity-25"></i>
                            </div>
                            <h5 class="text-muted fw-bold">Nici o operațiune nu corespunde filtrului.</h5>
                        </div>

                        <form method="POST" id="bulkForm-{{ company.id }}" action="/admin/stock/delete_bulk">
                            <!-- Bulk Actions Toolbar -->
                            <div class="bg-light p-3 border-bottom d-flex align-items-center gap-3"
                                id="bulkActions-{{ company.id }}" style="display: none;">
                                <span class="fw-bold text-muted small text-uppercase">Acțiuni Grup:</span>
                                <button type="submit" class="btn btn-sm btn-danger shadow-sm"
                                    onclick="return confirmSubmit(event, 'Sigur doriți să ștergeți elementele selectate?');">
                                    <i class="bi bi-trash me-1"></i> Șterge
                                </button>
                                <div class="vr mx-2"></div>
                                <div class="slim-action-bar flex-grow-1">
                                    <div class="px-3 py-1 bg-light border-end">
                                        <span class="small fw-bold text-muted"><i class="bi bi-arrow-right-short"></i>
                                            Mută selecția la:</span>
                                    </div>
                                    <div class="custom-dropdown-container" style="min-width: 200px;">
                                        <input type="hidden" name="new_company_id" value="">
                                        <button type="button" class="custom-dropdown-btn">
                                            <span class="btn-label-content">-- Alege Firma --</span>
                                            <i class="bi bi-chevron-down dropdown-chevron"></i>
                                        </button>
                                        <div class="custom-dropdown-menu">
                                            {% for c in companies %}
                                            {% if c.id != company.id %}
                                            <div class="custom-dropdown-item py-2" data-value="{{ c.id }}">{{ c.name }}
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <button type="submit" formaction="/admin/stock/move_bulk"
                                        class="btn-action-slim mx-1">
                                        Execută Mutarea
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive" id="tableContainer-{{ company.id }}">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light text-muted small text-uppercase">
                                        <tr>
                                            <th style="width: 40px; display: none;"
                                                class="selection-col-{{ company.id }} text-center">
                                                <input type="checkbox" class="form-check-input"
                                                    onclick="toggleAll(this, '{{ company.id }}')">
                                            </th>
                                            <th class="ps-4" style="width: 15%;">Data & Ora</th>
                                            <th class="text-center" style="width: 10%;">Tip</th>
                                            <th class="text-end" style="width: 15%;">Cantitate</th>
                                            <th class="ps-5">Detalii / Vehicul</th>
                                            <th class="text-center pe-4" style="width: 15%;">Acțiuni</th>
                                        </tr>
                                    </thead>
                                    <tbody class="border-top-0">
                                        {% for item in stocks[company.id]['history'] %}
                                        <tr class="history-row-{{ company.id }}">
                                            <td style="display: none;"
                                                class="selection-col-{{ company.id }} text-center section-cell">
                                                <input type="checkbox" name="operation_ids"
                                                    value="{{ 'trans' if item.type == 'TRANSACTION' else 'op' }}:{{ item.id }}"
                                                    class="form-check-input chk-{{ company.id }}">
                                            </td>
                                            <td class="ps-4 text-nowrap">
                                                <div class="fw-medium">{{ item.date.strftime('%d.%m.%Y') }}</div>
                                                <small class="text-muted">{{ item.date.strftime('%H:%M') }}</small>
                                            </td>
                                            <td class="text-center">
                                                {% if item.type == 'TRANSACTION' %}
                                                <span
                                                    class="badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle">CONSUM</span>
                                                {% elif item.type == 'IN' %}
                                                <span
                                                    class="badge rounded-pill bg-success-subtle text-success border border-success-subtle">INTRARE</span>
                                                {% elif item.type == 'INITIAL' %}
                                                <span
                                                    class="badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle">INIȚIAL</span>
                                                {% else %}
                                                <span
                                                    class="badge rounded-pill bg-warning-subtle text-warning border border-warning-subtle">{{
                                                    item.type }}</span>
                                                {% endif %}
                                            </td>
                                            <td
                                                class="fw-bold font-monospace text-end {% if item.type == 'INITIAL' %}text-blue{% elif item.type == 'IN' %}text-success{% endif %}">
                                                {{
                                                item.quantity|format_thousands(2) }} L
                                            </td>
                                            <td class="ps-5">
                                                {% if item.is_unallocated %}
                                                <span class="text-danger fw-medium"><i
                                                        class="bi bi-exclamation-triangle-fill me-1"></i> {{
                                                    item.description }}</span>
                                                <span class="badge bg-danger ms-1">NEALOCAT</span>
                                                {% else %}
                                                {% if item.type == 'TRANSACTION' %}
                                                <i class="bi bi-truck me-1 text-muted"></i>
                                                {% elif item.type == 'INITIAL' %}
                                                <i class="bi bi-file-text me-1 text-blue"></i>
                                                {% elif item.type == 'IN' %}
                                                <i class="bi bi-file-text me-1 text-success"></i>
                                                {% else %}
                                                <i class="bi bi-file-text me-1 text-muted"></i>
                                                {% endif %}
                                                <span
                                                    class="{% if item.type == 'INITIAL' %}text-blue{% elif item.type == 'IN' %}text-success{% endif %}">{{
                                                    item.description }}</span>
                                                {% if item.category %}
                                                <span class="badge bg-light text-dark border ms-2 fw-normal small">{{
                                                    item.category }}</span>
                                                {% endif %}
                                                {% endif %}
                                            </td>
                                            <td class="text-center pe-4">
                                                <div class="btn-group btn-group-sm">
                                                    {% if item.type != 'TRANSACTION' %}
                                                    <a href="/admin/stock/edit/{{ item.id }}"
                                                        class="btn btn-outline-secondary" title="Modifică"><i
                                                            class="bi bi-pencil"></i></a>
                                                    <a href="/admin/stock/move/op/{{ item.id }}"
                                                        class="btn btn-outline-secondary" title="Mută"><i
                                                            class="bi bi-arrow-left-right"></i></a>
                                                    <a href="/admin/stock/delete_item/op/{{ item.id }}"
                                                        class="btn btn-outline-danger" title="Șterge"
                                                        onclick="return confirmAction(event, 'Sigur doriți să ștergeți această înregistrare?');"><i
                                                            class="bi bi-trash"></i></a>
                                                    {% else %}
                                                    <button type="button" onclick="showExisting({{ item.id }})"
                                                        class="btn btn-outline-secondary" title="Vezi Detalii"><i
                                                            class="bi bi-eye"></i></button>
                                                    <a href="/admin/stock/move/trans/{{ item.id }}"
                                                        class="btn btn-outline-secondary" title="Mută"><i
                                                            class="bi bi-arrow-left-right"></i></a>
                                                    <a href="/admin/stock/delete_item/trans/{{ item.id }}"
                                                        class="btn btn-outline-danger" title="Șterge"
                                                        onclick="return confirmAction(event, 'Sigur doriți să ștergeți această înregistrare?');"><i
                                                            class="bi bi-trash"></i></a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
            {% endfor %}

            <div class="tab-pane fade {{ 'show active' if (active_company_id == -1) else '' }}" id="content-unallocated"
                role="tabpanel">

                {% if not unallocated_history %}
                <div class="text-center py-5 fade-in">
                    <div class="mb-3">
                        <div class="d-inline-block p-4 rounded-circle bg-success bg-opacity-10">
                            <i class="bi bi-check-circle-fill display-3 text-success"></i>
                        </div>
                    </div>
                    <h4 class="text-success fw-bold">Totul este alocat corect!</h4>
                    <p class="text-muted">Nu există alimentări nealocate momentan. <br>Toate tranzacțiile sunt
                        atribuite
                        unei firme.</p>
                </div>
                {% else %}
                <!-- Detailed Stats (Mirrors Company View) -->
                <div class="row g-4 mb-4">
                    <!-- Current Net Stock -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm" style="background-color: #dc35450D;">
                            <div class="card-body text-center d-flex flex-column justify-content-center p-4">
                                <h6 class="text-uppercase fw-bold mb-3" style="color: #dc3545;">Stoc Actual
                                    Nealocat
                                </h6>
                                <div class="display-4 fw-bold mb-2" style="color: #dc3545;">
                                    {{ unallocated_stats['current']|format_thousands(2) }} <span class="fs-4">L</span>
                                </div>
                                <div class="small" style="color: #dc3545A0;">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Reprezintă tranzacții sau intrări fără firmă atribuită
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary List -->
                    <div class="col-md-6">
                        <div class="card h-100 border shadow-sm">
                            <div class="card-header bg-transparent py-3">
                                <h6 class="mb-0 fw-bold">Sumar Total</h6>
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush h-100 justify-content-center">
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                        <span><i class="bi bi-skip-start-circle me-2 text-blue"></i>Inițial
                                            (Nealocat)</span>
                                        <span class="fw-bold text-blue">{{
                                            unallocated_stats['initial']|format_thousands(2) }} L</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                        <span><i class="bi bi-arrow-down-circle me-2 text-success"></i>Intrări
                                            (Nealocate)</span>
                                        <span class="fw-bold text-success">+{{
                                            unallocated_stats['in']|format_thousands(2) }} L</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                        <span><i class="bi bi-arrow-up-circle me-2 text-danger"></i>Consum
                                            (Nealocat)</span>
                                        <span class="fw-bold text-danger">-{{
                                            unallocated_stats['consumed']|format_thousands(2) }} L</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warning Banner -->
                <div class="alert alert-danger border-danger d-flex align-items-center mb-4">
                    <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                    <div>
                        <h5 class="mb-1 fw-bold">Alimentări nealocate</h5>
                        <p class="mb-0">Aceste alimentări nu sunt atribuite niciunei firme. Puteți să le
                            atribuiți
                            folosind acțiunile din tabel.</p>
                    </div>
                </div>

                <!-- History Table -->
                <form method="POST" id="unallocatedBulkForm" class="mb-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-danger bg-opacity-10 text-danger small text-uppercase">
                                <tr>
                                    <th style="width: 50px;" class="text-center selection-cell">
                                        {# S-a scos Select All la cererea utilizatorului #}
                                    </th>
                                    <th class="ps-4" style="width: 15%;">Data & Ora</th>
                                    <th class="text-center" style="width: 10%;">Tip</th>
                                    <th class="text-end" style="width: 15%;">Cantitate</th>
                                    <th class="ps-5">Detalii / Vehicul</th>
                                    <th class="text-center pe-4" style="width: 15%;">Acțiuni</th>
                                </tr>
                            </thead>
                            <tbody class="border-top-0">
                                {% for item in unallocated_history %}
                                <tr class="border-start border-danger border-4 unallocated-row">
                                    <td class="text-center selection-cell" onclick="toggleRowSelection(this, event)">
                                        {% if item.item_type == 'trans' %}
                                        <input type="checkbox" name="transaction_ids" value="{{ item.id }}"
                                            class="premium-checkbox row-checkbox unallocated-checkbox">
                                        {% else %}
                                        <input type="checkbox" name="operation_ids" value="{{ item.id }}"
                                            class="premium-checkbox row-checkbox unallocated-checkbox">
                                        {% endif %}
                                    </td>
                                    <td class="ps-4 text-nowrap">
                                        <div class="fw-medium">{{ item.date.strftime('%d.%m.%Y') }}
                                        </div>
                                        <small class="text-muted">{{ item.date.strftime('%H:%M')
                                            }}</small>
                                    </td>
                                    <td class="text-center">
                                        {% if item.item_type == 'trans' %}
                                        <span class="badge bg-danger rounded-pill px-3 py-2 shadow-sm">
                                            <i class="bi bi-fuel-pump-fill me-1"></i> ALIMENTARE
                                        </span>
                                        {% else %}
                                        <span class="badge bg-info text-dark rounded-pill px-3 py-2 shadow-sm">
                                            <i class="bi bi-database-fill me-1"></i> {{ item.type }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold fs-5 text-danger">{{
                                            item.quantity|format_thousands(2) }} L
                                        </div>
                                    </td>
                                    <td class="ps-5">
                                        <div class="d-flex align-items-center gap-2">
                                            {% if item.item_type == 'trans' %}
                                            <i class="bi bi-truck text-muted"></i>
                                            {% else %}
                                            <i class="bi bi-hdd-stack text-muted"></i>
                                            {% endif %}

                                            <div>
                                                <div class="fw-medium">{{ item.description }}</div>
                                                {% if item.category != 'SISTEM' %}
                                                <small class="text-muted">{{ item.category
                                                    }}</small>
                                                {% endif %}
                                                <span class="badge bg-warning text-dark ms-2">NEALOCAT</span>
                                                {% if item.duplicate_info %}
                                                <div class="mt-1 text-danger small fw-bold">
                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                    Posibil Duplicat! (Există la: {{
                                                    item.duplicate_info.plate }})
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center pe-4">
                                        <div class="btn-group">
                                            {% if item.item_type == 'trans' %}
                                            <button type="button" onclick="showExisting({{ item.id }})"
                                                class="btn btn-outline-secondary" title="Vezi Detalii"><i
                                                    class="bi bi-eye"></i></button>
                                            {% endif %}

                                            <a href="/admin/stock/move/{{ item.item_type }}/{{ item.id }}"
                                                class="btn btn-outline-warning" title="Alocă la o firmă"><i
                                                    class="bi bi-building-check"></i></a>
                                            <a href="/admin/stock/delete_item/{{ item.item_type }}/{{ item.id }}"
                                                class="btn btn-outline-danger" title="Șterge"
                                                onclick="return confirmAction(event, 'Sigur doriți să ștergeți această înregistrare?');"><i
                                                    class="bi bi-trash"></i></a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Unified Floating Bulk Menu (Global - outside tabs) -->
<!-- Unified Floating Bulk Menu v6.2 (Master Action Bar) -->
<div id="unifiedBulkMenu" class="floating-bulk-menu">
    <div class="selection-info">
        <div id="selectionCount">0</div>
        <span class="selection-label">Elemente</span>
    </div>

    <div class="bulk-actions d-flex align-items-center gap-2">
        <!-- Delete Action -->
        <button type="button" class="btn bulk-action-btn btn-action-delete" onclick="executeBulkDelete()"
            title="Șterge Selecția">
            <i class="bi bi-trash3-fill"></i>
            <span>Șterge</span>
        </button>

        <!-- Rename Action (NEW v6.2) -->
        <button type="button" class="btn bulk-action-btn btn-action-rename" onclick="executeBulkRename()"
            title="Redenumește Vehiculul">
            <i class="bi bi-pencil-square"></i>
            <span>Redenumește</span>
        </button>

        <!-- Change Company Action (NEW Modal v6.2) -->
        <button type="button" class="btn bulk-action-btn btn-action-assign" onclick="executeBulkAssignModal()"
            title="Atribuie la o firmă">
            <i class="bi bi-building-fill-check"></i>
            <span>Atribuie la o firmă</span>
        </button>
    </div>

    <button type="button" class="btn-deselect-all ms-2" onclick="deselectAll()" title="Resetează selecția">
        <i class="bi bi-x-lg"></i>
    </button>
</div>

<datalist id="vehicleList">
    {% for plate in vehicles_autocomplete %}
    <option value="{{ plate }}">
        {% endfor %}
</datalist>

<script>
    const existingVehicles = {{ vehicles_autocomplete| tojson if vehicles_autocomplete else '[]' }};

    function updatePlaceholder(companyId) {
        var select = document.getElementById('opType-' + companyId);
        var input = document.getElementById('desc-' + companyId);
        var label = document.getElementById('label-' + companyId);
        var val = select.value;

        if (val === 'OUT') {
            input.placeholder = "Număr Înmatriculare / Utilaj";
            label.innerText = "Număr Înmatriculare / Utilaj";
        } else {
            input.placeholder = "Descriere / Nr. Document / Observații";
            label.innerText = "Descriere / Nr. Document / Observații";
        }
        checkVehicle(input, companyId);
    }

    function checkVehicle(input, companyId) {
        var select = document.getElementById('opType-' + companyId);
        var badge = document.getElementById('newBadge-' + companyId);
        var val = input.value.trim().toUpperCase();

        // Remove special characters for plate matching (allow space and dash)
        // input.value = input.value.replace(/[^a-zA-Z0-9\s-]/g, '');

        if (select.value === 'OUT' && val.length > 2) {
            if (!existingVehicles.includes(val)) {
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        } else {
            badge.classList.add('d-none');
        }
    }

    // --- Master Selection Engine v6.2 (Select All Eliminat) ---
    // S-a eliminat funcția toggleSelectAll la cererea utilizatorului.

    // Helper to get consistent theme for SweetAlert
    function getSwalTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        return {
            background: isDark ? '#1a1a1a' : '#fff',
            color: isDark ? '#fff' : '#212529',
            confirmButtonColor: '#00b894',
            cancelButtonColor: '#6c757d'
        };
    }

    function toggleSelectionMode(companyId) {
        // Toggle the checkboxes visibility in the table
        const cells = document.querySelectorAll('.selection-col-' + companyId);
        const isCurrentlyHidden = cells.length > 0 && cells[0].style.display === 'none';

        cells.forEach(cell => {
            cell.style.display = isCurrentlyHidden ? 'table-cell' : 'none';
        });

        // Show/Hide the stationary toolbar
        const toolbar = document.getElementById('bulkActions-' + companyId);
        if (toolbar) {
            toolbar.style.display = isCurrentlyHidden ? 'flex' : 'none';
        }

        // Add class to table to enable row highlighting on hover
        const table = document.getElementById('tableContainer-' + companyId)?.querySelector('table');
        if (table) {
            table.classList.toggle('select-mode-active', isCurrentlyHidden);
        }

        // Add a class to the button to show state
        const btn = document.querySelector(`button[onclick="toggleSelectionMode('${companyId}')"]`);
        if (btn) {
            btn.classList.toggle('btn-primary', isCurrentlyHidden);
            btn.classList.toggle('btn-outline-secondary', !isCurrentlyHidden);
            btn.innerHTML = isCurrentlyHidden ? '<i class="bi bi-x-lg me-1"></i> Închide Selecția' : '<i class="bi bi-check2-square me-1"></i> Selecție Multiplă';
        }
    }

    function toggleRowSelection(cell, event) {
        // Prevent double-toggle if clicking checkbox directly
        if (event && event.target.classList.contains('premium-checkbox')) {
            updateUnifiedFloatingMenu();
            return; // No master checkbox to sync
        }

        const checkbox = cell.querySelector('.premium-checkbox');
        if (checkbox) {
            checkbox.checked = !checkbox.checked;
            updateUnifiedFloatingMenu();
        }
    }

    function syncMasterCheckbox() {
        // --- Master Selection Engine v6.2 (Select All Eliminat) ---
        // Funcția toggleSelectAll a fost scoasă.
        // This function is now effectively deprecated as there are no master checkboxes to sync.
        // It's kept as a placeholder to avoid breaking existing calls, but does nothing.
    }


    function toggleAll(source, companyId) {
        const table = source.closest('table');
        const checkboxes = table.querySelectorAll('tbody .chk-' + companyId);
        checkboxes.forEach(cb => {
            cb.checked = source.checked;
        });
    }

    function deselectAll() {
        const checkboxes = document.querySelectorAll('.premium-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = false;
        });
        updateUnifiedFloatingMenu();
    }

    function updateUnifiedFloatingMenu() {
        const checkedBoxes = document.querySelectorAll('tbody .unallocated-checkbox:checked');
        const menu = document.getElementById('unifiedBulkMenu');
        const countSpan = document.getElementById('selectionCount');

        if (checkedBoxes.length > 0) {
            countSpan.innerText = checkedBoxes.length;
            menu.classList.add('active');
        } else {
            menu.classList.remove('active');
            document.querySelectorAll('thead .premium-checkbox').forEach(m => {
                m.checked = false;
                m.indeterminate = false;
            });
        }

        // Force visual highlight on all selected rows across all tables
        document.querySelectorAll('tbody tr').forEach(row => {
            const chk = row.querySelector('.premium-checkbox');
            if (chk && chk.checked) {
                row.classList.add('row-selected');
            } else {
                row.classList.remove('row-selected');
            }
        });
    }


    // Company Data for Modal
    const availableCompanies = {
        {% for c in companies %}
    "{{ c.id }}": "{{ c.name }}",
        {% endfor %}
    };

    function executeBulkAssignModal() {
        const count = document.querySelectorAll('tbody .premium-checkbox:checked').length;
        const theme = getSwalTheme();

        let listHtml = '<div class="list-group list-group-flush rounded-3 border overflow-hidden">';
        for (const [id, name] of Object.entries(availableCompanies)) {
            listHtml += `
                <button type="button" class="list-group-item list-group-item-action d-flex align-items-center py-3 border-bottom company-btn" 
                        data-id="${id}" onclick="selectCompanyForBulk(this, '${id}')"
                        style="background: transparent; color: inherit; border: none; text-align: left;">
                    <div class="company-point me-3 bg-secondary bg-opacity-25 rounded-circle" style="width: 12px; height: 12px; border: 2px solid #6c757d;"></div>
                    <span class="fs-6 fw-medium">${name}</span>
                </button>
            `;
        }
        listHtml += '</div><input type="hidden" id="selected-company-id-swal">';

        Swal.fire({
            title: 'Atribuie la o firmă',
            html: `
                <p class="mb-3 opacity-75 small text-start">Alege firma pentru cele ${count} elemente:</p>
                <div style="max-height: 300px; overflow-y: auto;">
                    ${listHtml}
                </div>
                <style>
                    .company-btn.active { background: rgba(255, 193, 7, 0.15) !important; color: #ffc107 !important; border-left: 4px solid #ffc107 !important; }
                    .company-btn.active .company-point { border-color: #ffc107 !important; background: #ffc107 !important; }
                    .company-btn:hover:not(.active) { background: rgba(255,255,255,0.05) !important; }
                </style>
            `,
            showCancelButton: true,
            confirmButtonText: 'Salvează',
            confirmButtonColor: '#ffc107',
            cancelButtonText: 'Anulează',
            background: theme.background,
            color: theme.color,
            width: '450px',
            preConfirm: () => {
                const companyId = document.getElementById('selected-company-id-swal').value;
                if (!companyId) {
                    Swal.showValidationMessage('Te rugám să alegi o firmă din listă!');
                }
                return companyId;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const activeTabPanel = document.querySelector('.tab-pane.show.active');
                const form = activeTabPanel.querySelector('form[id^="bulkForm-"], form#unallocatedBulkForm');
                if (form) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'target_company_id';
                    input.value = result.value;
                    form.appendChild(input);
                    form.action = "/admin/stock/allocate_bulk";
                    form.submit();
                }
            }
        });
    }

    function selectCompanyForBulk(btn, id) {
        document.querySelectorAll('.company-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('selected-company-id-swal').value = id;
    }



    document.addEventListener('change', function (e) {
        if (e.target.classList.contains('premium-checkbox')) {
            const table = e.target.closest('table');
            if (table) {
                const master = table.querySelector('thead .premium-checkbox');
                const tbodyBoxes = Array.from(table.querySelectorAll('tbody .premium-checkbox'));

                if (master && e.target !== master) {
                    const checkedCount = tbodyBoxes.filter(cb => cb.checked).length;
                    master.checked = checkedCount === tbodyBoxes.length && tbodyBoxes.length > 0;
                    master.indeterminate = checkedCount > 0 && checkedCount < tbodyBoxes.length;
                }
            }
            updateUnifiedFloatingMenu();
        }
    });

    let lastChecked = null;
    document.addEventListener('click', function (e) {
        if (e.target.classList.contains('premium-checkbox')) {
            const checkbox = e.target;
            if (e.shiftKey && lastChecked && lastChecked.name === checkbox.name) {
                const table = checkbox.closest('table');
                const checkboxes = Array.from(table.querySelectorAll('tbody .premium-checkbox'));
                const start = checkboxes.indexOf(lastChecked);
                const end = checkboxes.indexOf(checkbox);

                if (start !== -1 && end !== -1) {
                    const range = checkboxes.slice(Math.min(start, end), Math.max(start, end) + 1);
                    range.forEach(cb => {
                        cb.checked = lastChecked.checked;
                    });
                    updateUnifiedFloatingMenu();
                }
            }
            lastChecked = checkbox;
        }
    });

    function executeBulkDelete() {
        const count = document.querySelectorAll('tbody .premium-checkbox:checked').length;
        const theme = getSwalTheme();
        Swal.fire({
            title: `Ștergi ${count} elemente?`,
            text: "Această acțiune este definitivă!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ff4757',
            cancelButtonColor: theme.cancelButtonColor,
            confirmButtonText: 'Da, șterge!',
            cancelButtonText: 'Anulează',
            background: theme.background,
            color: theme.color
        }).then((result) => {
            if (result.isConfirmed) {
                const activeTabPanel = document.querySelector('.tab-pane.show.active');
                const form = activeTabPanel.querySelector('form[id^="bulkForm-"], form#unallocatedBulkForm');
                if (form) {
                    form.action = "/admin/stock/delete_bulk";
                    form.submit();
                }
            }
        });
    }

    function executeBulkRename() {
        const count = document.querySelectorAll('tbody .premium-checkbox:checked').length;
        const theme = getSwalTheme();
        Swal.fire({
            title: 'Redenumire Vehicul',
            html: `
                <p class="mb-3 opacity-75 small">Vei schimba vehiculul pentru ${count} înregistrări. <br>Poți alege un vehicul existent din listă vagy poți introduce unul nou.</p>
                <div class="position-relative">
                    <input type="text" id="swal-rename-plate" class="form-control py-3 px-4 rounded-3 fs-5" 
                           placeholder="Număr vehicul / Nume..." list="vehicleList" autocomplete="off" style="text-transform: uppercase;">
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Salvează',
            confirmButtonColor: theme.confirmButtonColor,
            cancelButtonText: 'Anulează',
            background: theme.background,
            color: theme.color,
            didOpen: () => {
                const input = document.getElementById('swal-rename-plate');
                if (input) input.focus();
            },
            preConfirm: () => {
                const value = document.getElementById('swal-rename-plate').value.trim().toUpperCase();
                if (!value) {
                    Swal.showValidationMessage('Te rugám să introduci un nume!');
                }
                return value;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const activeTabPanel = document.querySelector('.tab-pane.show.active');
                const form = activeTabPanel.querySelector('form[id^="bulkForm-"], form#unallocatedBulkForm');
                if (form) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'new_plate';
                    input.value = result.value;
                    form.appendChild(input);
                    form.action = "/admin/stock/rename_vehicle_bulk";
                    form.submit();
                }
            }
        });
    }

    function executeBulkAction(btn) {
        // Obsolete in v6.2 - Modals used instead
    }

</script>

<style>
    /* Dynamic Neon Tabs */
    #companyTabs .nav-link {
        color: var(--bs-nav-link-color) !important;
        opacity: 0.7;
        transition: all 0.3s ease;
        border: none !important;
        /* Remove standard borders */
    }

    #companyTabs .nav-link:hover {
        opacity: 1;
        background-color: rgba(var(--bs-light-rgb), 0.5);
    }

    #companyTabs .nav-link.active {
        opacity: 1;
        background-color: transparent !important;
        font-weight: 700;
        color: var(--tab-color) !important;
    }

    /* --- Master Level Selection System --- */
    .selection-cell {
        cursor: pointer;
        position: relative;
        transition: background-color 0.2s ease;
    }

    .selection-cell:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    /* Professional Custom Checkbox */
    .premium-checkbox {
        position: relative;
        width: 22px;
        height: 22px;
        background: #fff;
        border: 2px solid #cbd5e0;
        border-radius: 6px;
        cursor: pointer;
        display: inline-block;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        vertical-align: middle;
        appearance: none;
        -webkit-appearance: none;
        outline: none;
    }

    .premium-checkbox:hover {
        border-color: #4299e1;
        box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.1);
    }

    .premium-checkbox:checked {
        background-color: #3182ce;
        border-color: #3182ce;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
        background-size: 80% 80%;
        background-position: center;
        background-repeat: no-repeat;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(49, 130, 206, 0.4);
    }

    .premium-checkbox:indeterminate {
        background-color: #3182ce;
        border-color: #3182ce;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='4' stroke-linecap='round'%3E%3Cline x1='5' y1='12' x2='19' y2='12'%3E%3C/line%3E%3C/svg%3E");
        background-size: 70% 70%;
        background-position: center;
        background-repeat: no-repeat;
    }

    /* Selected Row Visuals - Premium High Visibility v8.0 */
    tr.row-selected {
        background-color: rgba(13, 110, 253, 0.25) !important;
        position: relative;
    }

    tr.row-selected td:first-child {
        border-left: 6px solid #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.1);
    }

    tr.row-selected td {
        border-bottom-color: rgba(13, 110, 253, 0.4) !important;
    }



    /* Row highlight on select mode */
    .select-mode-active tr:hover td {
        background-color: rgba(13, 110, 253, 0.02);
    }

    /* Floating Bulk Menu v6.2 - Elegant Dark System */
    .floating-bulk-menu {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%) translateY(120px);
        background: rgba(20, 20, 30, 0.95) !important;
        backdrop-filter: blur(25px) saturate(220%);
        -webkit-backdrop-filter: blur(25px) saturate(220%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        border-radius: 24px;
        padding: 10px 14px;
        z-index: 9999;
        transition: all 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        opacity: 0;
        visibility: hidden;
        display: flex;
        align-items: center;
        gap: 12px;
        pointer-events: none;
    }

    .floating-bulk-menu.active {
        opacity: 1 !important;
        visibility: visible !important;
        transform: translateX(-50%) translateY(0);
        pointer-events: all;
    }

    .selection-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0 16px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    #selectionCount {
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        color: white;
        min-width: 32px;
        height: 32px;
        padding: 0 8px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1rem;
        box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
    }

    .selection-label {
        font-weight: 700;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }

    .bulk-action-btn {
        height: 42px;
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 18px;
        border-radius: 16px;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
        color: white;
    }

    .btn-action-delete {
        background: rgba(255, 71, 87, 0.1);
        color: #ff4757;
        border-color: rgba(255, 71, 87, 0.2);
    }

    .btn-action-delete:hover {
        background: #ff4757;
        color: white;
        box-shadow: 0 10px 20px rgba(255, 71, 87, 0.3);
    }

    .btn-action-rename {
        background: #00b894 !important;
        color: white !important;
        border-color: #00b894 !important;
    }

    .btn-action-rename:hover {
        background: #00a082 !important;
        box-shadow: 0 10px 20px rgba(0, 184, 148, 0.4) !important;
    }



    .btn-action-assign {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border-color: rgba(255, 193, 7, 0.2);
    }

    .btn-action-assign:hover {
        background: #ffc107;
        color: #000;
        box-shadow: 0 10px 20px rgba(255, 193, 7, 0.3);
    }



    .btn-deselect-all {
        width: 38px;
        height: 38px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .btn-deselect-all:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: rotate(90deg);
    }

    /* Master Dropdown Overrides */
    .floating-bulk-menu .custom-dropdown-menu {
        border-radius: 16px;
        padding: 8px;
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.4);
    }

    .floating-bulk-menu .custom-dropdown-item {
        border-radius: 10px;
        transition: all 0.2s ease;
    }

    .floating-bulk-menu .custom-dropdown-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .btn-primary-dark {
        background: #6c5ce7;
        border-color: #6c5ce7;
        color: white;
    }

    .btn-primary-dark:hover {
        background: #5b4bc4;
        box-shadow: 0 10px 25px rgba(108, 92, 231, 0.4);
    }

    #companyTabs .nav-link.active::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--tab-color);
        box-shadow: 0 0 12px var(--tab-color), 0 0 5px var(--tab-color);
        /* Stronger Neon */
        border-radius: 10px 10px 0 0;
        animation: neon-pulse 1.5s infinite alternate;
    }



    @keyframes neon-pulse {
        from {
            box-shadow: 0 0 8px var(--tab-color);
            opacity: 0.8;
        }

        to {
            box-shadow: 0 0 15px var(--tab-color);
            opacity: 1;
        }
    }
</style>

<script>
    function generateStockSnapshot() {
        const btn = document.querySelector('button[onclick="generateStockSnapshot()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Procesare...';

        // Choose the element to capture (main content)
        const element = document.querySelector('.container-fluid') || document.body;

        html2canvas(element, {
            scale: 2,
            backgroundColor: "#ffffff",
            useCORS: true,
            logging: false,
            ignoreElements: (el) => {
                // Ignore the snapshot button itself and other UI elements that shouldn't be in a report
                return el.tagName === 'BUTTON' || el.classList.contains('navbar') || el.classList.contains('btn-group');
            }
        }).then(canvas => {
            const imageData = canvas.toDataURL("image/png");

            fetch('/api/snapshot/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
                .then(response => response.json())
                .then(data => {
                    btn.innerHTML = originalText;
                    if (data.success) {
                        Swal.fire({
                            title: 'Snapshot Salvat!',
                            html: `Imaginea <b>${data.filename}</b> a fost salvată în <b>Downloads</b>.`,
                            icon: 'success',
                            confirmButtonColor: '#0d6efd'
                        });
                    } else {
                        Swal.fire('Eroare', data.message, 'error');
                    }
                })
                .catch(err => {
                    btn.innerHTML = originalText;
                    Swal.fire('Eroare', 'Eroare server.', 'error');
                });
        });
    }
</script>
{% endblock %}